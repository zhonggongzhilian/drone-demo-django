{% extends "layouts/base.html" %}

{% load static %}

{% block title %} 直播画面 {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<style>
.content {
  background-image: url("{% static 'assets/img/live_bg.jpg' %}");
  background-size: cover; /* 使背景图片覆盖整个区域 */
  background-position: center; /* 背景图片居中对齐 */
  background-repeat: no-repeat; /* 防止背景图片重复 */
  height: 100vh; /* 使内容高度为视口高度 */
  margin: 0;
  position: relative; /* 使卡片容器可以使用绝对定位 */
}

.video-container {
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center; /* 居中对齐视频元素 */
  align-items: center; /* 垂直居中视频元素 */
}

.video-wrapper {
  position: relative;
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center; /* 居中对齐视频和图片 */
  align-items: center; /* 垂直居中 */
}

.video-element, .img-element {
  position: absolute; /* 绝对定位，使图片和视频叠加 */
  width: 100%;
  height: 100%;
  object-fit: cover; /* 保持比例 */
  cursor: pointer; /* 鼠标悬停效果 */
}

.img-element {
  z-index: 1; /* 确保图片在视频下方 */
}

.video-element {
  z-index: 2; /* 确保视频在图片上方 */
  display: none; /* 默认隐藏视频 */
}

.card-container {
  position: absolute; /* 绝对定位卡片容器 */
  top: 100px; /* 从顶部距离 */
  right: 20px; /* 从右侧距离 */
  display: flex;
  flex-direction: column; /* 垂直排列卡片 */
  gap: 20px; /* 增加卡片间的间距 */
  padding: 15px; /* 内边距 */
  border-radius: 10px; /* 圆角 */
  backdrop-filter: blur(10px); /* 半透明毛玻璃效果 */
  width: 350px; /* 增加卡片容器宽度 */
  z-index: 10; /* 确保卡片容器在视频上方 */
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* 卡片容器阴影 */
}

.card-info {
  background: rgba(255, 255, 255, 0.2); /* 半透明背景色 */
  border-radius: 10px; /* 圆角 */
  padding: 15px; /* 内边距 */
  display: flex;
  flex-direction: column; /* 使卡片内容垂直排列 */
  transition: background-color 0.3s ease, box-shadow 0.3s ease; /* 添加过渡效果 */
  backdrop-filter: blur(10px); /* 半透明毛玻璃效果 */
}

.card-info:hover {
  background: rgba(255, 255, 255, 0.3); /* 悬停时背景色变为更亮的白色 */
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); /* 悬停时阴影效果 */
}

.card-title {
  font-size: 18px; /* 标题字体大小 */
  font-weight: bold; /* 标题加粗 */
  margin-bottom: 10px; /* 标题和内容间距 */
  color: #333; /* 标题颜色 */
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4); /* 文字阴影效果 */
}

.card-table {
  width: 100%;
  border-collapse: collapse; /* 去掉表格间隙 */
  background: transparent; /* 表格背景透明 */
}

.card-table th, .card-table td {
  padding: 10px; /* 单元格内边距 */
  border: 1px solid transparent; /* 透明边框 */
  white-space: nowrap; /* 防止内容换行 */
  color: #333; /* 文本颜色 */
}

.card-table th {
  background: rgba(255, 255, 255, 0.3); /* 表头背景色 */
  font-weight: bold; /* 表头加粗 */
}

.card-table td {
  background: transparent; /* 单元格背景透明 */
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2); /* 文字阴影效果 */
}
</style>
{% endblock stylesheets %}

{% block content %}
<div class="content">
  <div class="video-container">
    <div class="video-wrapper">
      <video id="videoElement" controls class="video-element"></video>
      <img src="http://1.13.23.62:6060/video_feed" id="imageElement" alt="Video Stream" class="img-element" />
    </div>
    <div class="card-container">
      <div id="droneInfo" class="card-info">
        <div class="card-title">无人机信息</div>
        <table class="card-table">
          {% if selected_drone %}
          <tr>
            <th>无人机名称</th>
            <td>{{ selected_drone.drone_model }}</td>
          </tr>
          <tr>
            <th>无人机编号</th>
            <td>{{ selected_drone.drone_sn }}</td>
          </tr>
          <tr>
            <th>远程编号</th>
            <td>{{ selected_drone.remote_sn }}</td>
          </tr>
          <tr>
            <th>工作空间ID</th>
            <td>{{ selected_drone.workspace_id }}</td>
          </tr>
          <tr>
            <th>状态</th>
            <td>{{ selected_drone.status }}</td>
          </tr>
          <tr>
            <th>经度</th>
            <td>{{ selected_drone.longitude }}</td>
          </tr>
          <tr>
            <th>纬度</th>
            <td>{{ selected_drone.latitude }}</td>
          </tr>
          {% endif %}
        </table>
      </div>
      <div class="card-info">
        <div class="card-title">预警信息</div>
        <table class="card-table">
          <tr>
            <th>巡检通知告警</th>
            <td>有火源！</td>
          </tr>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const videoElement = document.getElementById('videoElement');
  const imageElement = document.getElementById('imageElement');
  const droneSelect = document.getElementById('droneSelect');
  const droneModel = document.getElementById('droneModel');
  const droneSn = document.getElementById('droneSn');
  const remoteSn = document.getElementById('remoteSn');
  const workspaceId = document.getElementById('workspaceId');
  const status = document.getElementById('status');
  const longitude = document.getElementById('longitude');
  const latitude = document.getElementById('latitude');

  // 从后端传递的无人机数据
  const drones = [
    {% for drone in drones %}
    {
      drone_sn: "{{ drone.drone_sn }}",
      drone_model: "{{ drone.drone_model }}",
      remote_sn: "{{ drone.remote_sn }}",
      workspace_id: "{{ drone.workspace_id }}",
      status: "{{ drone.get_status_display }}",
      longitude: "{{ drone.longitude }}",
      latitude: "{{ drone.latitude }}"
    },
    {% endfor %}
  ];

  // 更新无人机信息显示
  function updateDroneInfo(selectedSn) {
    const drone = drones.find(d => d.drone_sn === selectedSn);
    if (drone) {
      droneModel.textContent = drone.drone_model || '---';
      droneSn.textContent = drone.drone_sn || '---';
      remoteSn.textContent = drone.remote_sn || '---';
      workspaceId.textContent = drone.workspace_id || '---';
      status.textContent = drone.status || '---';
      longitude.textContent = drone.longitude || '---';
      latitude.textContent = drone.latitude || '---';
    } else {
      droneModel.textContent = '---';
      droneSn.textContent = '---';
      remoteSn.textContent = '---';
      workspaceId.textContent = '---';
      status.textContent = '---';
      longitude.textContent = '---';
      latitude.textContent = '---';
    }
  }

  // 处理无人机选择变化事件
  droneSelect.addEventListener('change', function() {
    updateDroneInfo(droneSelect.value);
  });

  if (Hls.isSupported()) {
    const hls = new Hls({
      // 适应性比特率配置
      maxMaxBufferLength: 30, // 最大缓存时间（秒）
      startLevel: 0, // 从最低质量开始
      capLevelToPlayerSize: true // 限制流质量适应播放器大小
    });
    hls.loadSource('http://192.168.43.21/hls/stream.m3u8');
    hls.attachMedia(videoElement);
    hls.on(Hls.Events.MANIFEST_PARSED, () => {
      videoElement.play();
      imageElement.style.display = 'none'; // 隐藏图片
      videoElement.style.display = 'block'; // 显示视频
    });
    hls.on(Hls.Events.ERROR, (event, data) => {
      if (data.fatal === Hls.ErrorTypes.NETWORK_ERROR) {
        imageElement.style.display = 'block';
        videoElement.style.display = 'none';
      }
    });
  } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
    videoElement.src = 'http://192.168.43.21/hls/stream.m3u8';
    videoElement.addEventListener('loadedmetadata', () => {
      videoElement.play();
      imageElement.style.display = 'none'; // 隐藏图片
      videoElement.style.display = 'block'; // 显示视频
    });
    videoElement.addEventListener('error', () => {
      imageElement.style.display = 'block';
      videoElement.style.display = 'none';
    });
  } else {
    imageElement.style.display = 'block';
    videoElement.style.display = 'none';
  }
});
</script>
{% endblock javascripts %}