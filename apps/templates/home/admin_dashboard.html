{% extends "layouts/base.html" %}
{% load static %}

{% block title %}后台管理{% endblock %}

{% block stylesheets %}
    {{ block.super }}
        <style>
        /* 设置视频背景样式 */
        .video-background {
            position: fixed;
            top: 0;
            left: 0;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            z-index: -2;
            object-fit: cover;
            filter: brightness(0.7); /* 调整视频亮度以提高内容可读性 */
        }

        /* 半透明遮罩层 */
        .video-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4); /* 黑色半透明遮罩 */
            z-index: -1;
        }

        /* 内容覆盖层 */
        .content-overlay {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: center; /* 水平居中 */
            align-items: flex-start; /* 垂直顶部对齐 */
            min-height: 100vh;
            box-sizing: border-box;
            padding: 20px; /* 增加内边距 */
            width: 100%; /* 页面宽度设为 100% */
        }

        /* 主卡片样式 */
        .main-card {
            width: 80%; /* 调整宽度以适应内容 */
            background: rgba(0, 0, 0, 0.9); /* 半透明黑色背景 */
            color: #fff; /* 白色文本 */
            padding: 20px;
            box-sizing: border-box;
            /* 去除圆角 */
            border-radius: 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            overflow-y: auto; /* 内容溢出时出现滚动条 */
            max-height: 100vh; /* 动态高度 */
            margin-top: 20px;
        }

        /* 分隔线样式 */
        .section-separator {
            border: none;
            border-top: 1px solid #444;
            margin: 20px 0;
        }

        /* 表格样式 */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #555;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #333;
        }

        /* 按钮样式 */
        .actions {
            margin-bottom: 15px;
        }
        .btn {
            margin-right: 10px;
        }

        /* 表格链接样式 */
        table a {
            color: #1e90ff; /* 蓝色链接 */
        }
        table a:hover {
            color: #63a4ff; /* 悬停时的颜色 */
            text-decoration: underline;
        }

        /* 模态框背景适配 */
        .modal-content {
            background-color: #2c2c2c;
            color: #fff;
            /* 去除圆角 */
            border-radius: 0;
        }
        .modal-header, .modal-footer {
            border: none;
        }
        .modal-title {
            color: #fff;
        }
        .form-control {
            background-color: #444;
            color: #fff;
            border: 1px solid #555;
        }
        .form-control::placeholder {
            color: #aaa;
        }
        .form-control:focus {
            background-color: #555;
            color: #fff;
            border-color: #1e90ff;
            box-shadow: none;
        }
        .form-group label {
            color: #fff;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .main-card {
                width: 95%;
                padding: 15px;
            }
        }
    </style>
{% endblock stylesheets %}

{% block content %}
    <!-- 背景视频 -->
    <video autoplay muted loop class="video-background" playsinline>
        <source src="{% static 'assets/img/bgv.mp4' %}" type="video/mp4">
        您的浏览器不支持 HTML5 视频。
    </video>

    <!-- 半透明遮罩层 -->
    <div class="video-overlay"></div>

    <!-- 内容覆盖层 -->
    <div class="content-overlay">
        <div class="main-card">
            <!-- 用户信息部分 -->
            <h4>用户信息</h4>
            <div class="actions">
                <button class="btn btn-primary" onclick="addUser()">新增</button>
                <button class="btn btn-warning" id="editButton" onclick="editSelected()" disabled>修改</button>
                <button class="btn btn-danger" onclick="deleteSelected()">删除</button>
            </div>
            <table>
                <thead>
                <tr>
                    <th><input type="checkbox" onclick="toggleAll(this)"></th>
                    <th>用户名</th>
                    <th>全名</th>
                    <th>邮箱</th>
                    <th>电话</th>
                    <th>上次登录时间</th>
                    <th>管理员</th>
                </tr>
                </thead>
                <tbody>
                {% for user in users %}
                <tr>
                    <td><input type="checkbox" class="user-checkbox" data-id="{{ user.id }}" onchange="toggleEditButton()">
                    </td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.full_name }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.phone_number }}</td>
                    <td>{{ user.last_login }}</td>
                    <td>{{ user.is_admin|yesno:"是,否" }}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>

            <!-- 分隔线 -->
            <hr class="section-separator">

            <!-- 历史设备部分 -->
            <h4>历史设备</h4>
            <div class="actions">
                <button class="btn btn-primary" onclick="addDrone()">新增</button>
                <button class="btn btn-danger" onclick="deleteSelectedDrones()">删除</button>
            </div>
            <table>
                <thead>
                <tr>
                    <th><input type="checkbox" onclick="toggleAllDrones(this)"></th>
                    <th>无人机型号</th>
                    <th>无人机序列号</th>
                    <th>远程控制器序列号</th>
                    <th>工作区ID</th>
                    <th>设备状态</th>
                    <th>用户</th>
                    <th>经度</th>
                    <th>纬度</th>
                </tr>
                </thead>
                <tbody>
                {% for drone in drones %}
                <tr>
                    <td><input type="checkbox" class="drone-checkbox" data-id="{{ drone.id }}" onchange="toggleEditDroneButton()"></td>
                    <td>{{ drone.drone_model }}</td>
                    <td>{{ drone.drone_sn }}</td>
                    <td>{{ drone.remote_sn }}</td>
                    <td>{{ drone.workspace_id }}</td>
                    <td>{{ drone.status }}</td>
                    <td>{{ drone.user.username }}</td>
                    <td>{{ drone.longitude }}</td>
                    <td>{{ drone.latitude }}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>

            <!-- 分隔线 -->
            <hr class="section-separator">

            <!-- 通知信息部分 -->
            <h4>通知信息</h4>
            <div class="actions">
                <button class="btn btn-danger" onclick="deleteSelectedNotifications()">删除</button>
            </div>
            <table id="notification-table">
                <thead>
                <tr>
                    <th><input type="checkbox" onclick="toggleAllNotifications(this)"></th>
                    <th>序号</th>
                    <th>时间戳</th>
                    <th>无人机序列号</th>
                    <th>纬度</th>
                    <th>经度</th>
                    <th>图像源</th>
                </tr>
                </thead>
                <tbody>
                {% for notification in notifications %}
                <tr data-id="{{ notification.id }}">
                    <td><input type="checkbox" class="notification-checkbox" data-drone-sn="{{ notification.DroneSN }}" data-timestamp="{{ notification.Timestamp }}"></td>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ notification.Timestamp }}</td>
                    <td>{{ notification.DroneSN }}</td>
                    <td>{{ notification.Latitude }}</td>
                    <td>{{ notification.Longitude }}</td>
                    <td><a href="{{ notification.ImageSource }}" target="_blank">查看图像</a></td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- 模态框，用于添加用户 -->
    <div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="addUserModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addUserModalLabel">新增用户</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="关闭">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="form-group">
                            <label for="username">用户名</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="form-group">
                            <label for="full_name">全名</label>
                            <input type="text" class="form-control" id="full_name" name="full_name" required>
                        </div>
                        <div class="form-group">
                            <label for="email">邮箱</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="phone_number">电话</label>
                            <input type="text" class="form-control" id="phone_number" name="phone_number" required>
                        </div>
                        <div class="form-group">
                            <label for="password">密码</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="form-group">
                            <label for="is_admin">管理员</label>
                            <select class="form-control" id="is_admin" name="is_admin" required>
                                <option value="false">否</option>
                                <option value="true">是</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="submitAddUser()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改用户模态框 -->
    <div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel">修改用户</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="关闭">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="edit_user_id" name="id">  <!-- Hidden input to store user ID -->
                        <div class="form-group">
                            <label for="edit_username">用户名</label>
                            <input type="text" class="form-control" id="edit_username" name="username" required>
                        </div>
                        <div class="form-group">
                            <label for="edit_full_name">全名</label>
                            <input type="text" class="form-control" id="edit_full_name" name="full_name" required>
                        </div>
                        <div class="form-group">
                            <label for="edit_email">邮箱</label>
                            <input type="email" class="form-control" id="edit_email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="edit_phone_number">电话</label>
                            <input type="text" class="form-control" id="edit_phone_number" name="phone_number" required>
                        </div>
                        <div class="form-group">
                            <label for="edit_is_admin">管理员</label>
                            <select class="form-control" id="edit_is_admin" name="is_admin" required>
                                <option value="false">否</option>
                                <option value="true">是</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="submitEditUser()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增无人机模态框 -->
    <div class="modal fade" id="addDroneModal" tabindex="-1" role="dialog" aria-labelledby="addDroneModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addDroneModalLabel">添加无人机</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="关闭">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="post" action="{% url 'admin_dashboard_add_drone' %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="droneModel">无人机型号</label>
                            <select id="droneModel" name="drone_model" class="form-control" required>
                                <option value="Air 3">Air 3</option>
                                <option value="Inspire 3">Inspire 3</option>
                                <option value="Mavic 3 Classic">Mavic 3 Classic</option>
                                <option value="Mavic 3 Pro">Mavic 3 Pro</option>
                                <option value="Mini 2 SE">Mini 2 SE</option>
                                <option value="Mini 3">Mini 3</option>
                                <option value="Mini 3 Pro">Mini 3 Pro</option>
                                <option value="Mini 4 Pro">Mini 4 Pro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="droneSn">无人机序列号</label>
                            <input type="text" id="droneSn" name="drone_sn" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="remoteSn">远程控制器序列号</label>
                            <input type="text" id="remoteSn" name="remote_sn" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="workspaceId">工作区ID</label>
                            <input type="text" id="workspaceId" name="workspace_id" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="status">设备状态</label>
                            <select id="status" name="status" class="form-control" required>
                                <option value="active">在线</option>
                                <option value="inactive">离线</option>
                                <option value="maintenance">维护中</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="longitude">经度</label>
                            <input type="text" id="longitude" name="longitude" class="form-control" value="119.24547"
                                   required>
                        </div>
                        <div class="form-group">
                            <label for="latitude">纬度</label>
                            <input type="text" id="latitude" name="latitude" class="form-control" value="32.26518" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                        <button type="submit" class="btn btn-primary">提交</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock content %}

{% block javascripts %}
    {{ block.super }}
    <script>
        function toggleAll(source) {
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = source.checked);
            toggleEditButton();
        }

        function toggleAllDrones(source) {
            const checkboxes = document.querySelectorAll('.drone-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = source.checked);
            // Optionally, add functionality if needed
        }

        function toggleAllNotifications(source) {
            const checkboxes = document.querySelectorAll('.notification-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = source.checked);
        }

        function toggleEditButton() {
            const selected = document.querySelectorAll('.user-checkbox:checked');
            const editButton = document.getElementById('editButton');
            editButton.disabled = selected.length !== 1;  // 仅当选中一个时启用“修改”按钮
        }

        function addUser() {
            $('#addUserModal').modal('show');
        }

        function submitAddUser() {
            const form = document.getElementById('addUserForm');
            const formData = new FormData(form);

            fetch("{% url 'add_user' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('添加用户失败');
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('发生错误');
            });
        }

        function addDrone() {
            $('#addDroneModal').modal('show');
        }

        function editSelected() {
            const selected = document.querySelectorAll('.user-checkbox:checked');
            if (selected.length === 1) {
                const userId = selected[0].getAttribute('data-id');

                fetch(`/users/${userId}/`)
                .then(response => response.json())
                .then(user => {
                    document.getElementById('edit_user_id').value = user.id;
                    document.getElementById('edit_username').value = user.username;
                    document.getElementById('edit_full_name').value = user.full_name;
                    document.getElementById('edit_email').value = user.email;
                    document.getElementById('edit_phone_number').value = user.phone_number;
                    document.getElementById('edit_is_admin').value = user.is_admin ? 'true' : 'false';
                    $('#editUserModal').modal('show');
                }).catch(error => {
                    console.error('Error:', error);
                    alert('无法获取用户信息');
                });
            } else {
                alert('请选择一个用户进行修改');
            }
        }

        function submitEditUser() {
            const form = document.getElementById('editUserForm');
            const formData = new FormData(form);
            const userId = formData.get('id');

            fetch(`/users/${userId}/update/`, {
                method: 'POST',
                body: JSON.stringify({
                    username: formData.get('username'),
                    full_name: formData.get('full_name'),
                    email: formData.get('email'),
                    phone_number: formData.get('phone_number'),
                    is_admin: formData.get('is_admin') === 'true'
                }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('修改用户失败');
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('发生错误');
            });
        }

        function deleteSelected() {
            const selected = [];
            document.querySelectorAll('.user-checkbox:checked').forEach(function(checkbox) {
                selected.push(checkbox.getAttribute('data-id'));
            });

            if (selected.length > 0) {
                if (confirm('确定要删除选中的用户吗？')) {
                    fetch("{% url 'delete_users' %}", {
                        method: 'POST',
                        body: JSON.stringify({ids: selected}),
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    }).then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('删除用户失败');
                        }
                    }).catch(error => {
                        console.error('Error:', error);
                        alert('发生错误');
                    });
                }
            } else {
                alert('请选择要删除的用户');
            }
        }

        function deleteSelectedDrones() {
            const selected = document.querySelectorAll('.drone-checkbox:checked');
            const ids = Array.from(selected).map(checkbox => checkbox.getAttribute('data-id'));

            if (ids.length > 0) {
                if (confirm('确定要删除选中的无人机吗？')) {
                    fetch("{% url 'admin_dashboard_delete_drones' %}", {
                        method: 'POST',
                        body: JSON.stringify({ ids: ids }),
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    }).then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('删除无人机失败');
                        }
                    }).catch(error => {
                        console.error('Error:', error);
                        alert('发生错误');
                    });
                }
            } else {
                alert('请选择要删除的无人机');
            }
        }

        function deleteSelectedNotifications() {
            const selectedCheckboxes = document.querySelectorAll('.notification-checkbox:checked');
            const notificationsToDelete = Array.from(selectedCheckboxes).map(checkbox => ({
                droneSN: checkbox.getAttribute('data-drone-sn'),
                timeStamp: checkbox.getAttribute('data-timestamp')
            }));

            if (notificationsToDelete.length === 0) {
                alert('请至少选择一个通知');
                return;
            }

            if (confirm('确定要删除选中的通知吗？')) {
                fetch('{% url "delete_notifications" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')  // 确保包含 CSRF token
                    },
                    body: JSON.stringify(notificationsToDelete)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('通知已删除');
                        location.reload();  // 重新加载页面以反映更改
                    } else {
                        alert('删除失败');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('发生错误');
                });
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
{% endblock javascripts %}